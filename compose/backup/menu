#!/bin/bash

# „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Ë®≠ÂÆö
set +e

BACKUP_ROOT="/backups"
HOST="${MYSQL_HOST:-oruca-mysql}"
USER="${MYSQL_USER:-root}"
PASS="${MYSQL_PASSWORD:-root}"
DB_NAME="${MYSQL_DATABASE:-OruCa_DB}"

# Ë°®Á§∫Áî®„ÅÆ„Éõ„Çπ„ÉàÂêçË®≠ÂÆö
# Áí∞Â¢ÉÂ§âÊï∞ ACCESSIBLE_HOST „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Åù„Çå„Çí‰Ωø„ÅÑ„ÄÅ„Å™„Åë„Çå„Å∞ 'localhost' „Çí‰ΩøÁî®
DISPLAY_HOST="${ACCESSIBLE_HOST:-localhost}"

show_header() {
    clear
    echo "========================================"
    echo "üì¶ OruCa Backup Utility (Portainer Mode)"
    echo "========================================"
    echo "Database: $DB_NAME"
    echo "Host: $HOST"
    echo "Access Host: $DISPLAY_HOST"
    echo "----------------------------------------"
}

do_backup() {
    DIR_NAME=$(date +%Y%m%d-%H%M%S)
    TARGET_DIR="${BACKUP_ROOT}/${DIR_NAME}"
    FILEPATH="${TARGET_DIR}/backup.sql"

    echo "üìÇ Creating directory: $TARGET_DIR ..."
    mkdir -p "$TARGET_DIR"

    echo "‚è≥ Dumping database to: $FILEPATH ..."
    mysqldump -h "$HOST" -u "$USER" -p"$PASS" --no-tablespaces "$DB_NAME" > "$FILEPATH"

    if [ $? -eq 0 ]; then
        echo "‚úÖ Success! Backup created."
    else
        echo "‚ùå Backup Failed!"
        rm -f "$FILEPATH"
        rmdir "$TARGET_DIR" 2>/dev/null
    fi
    read -p "Press Enter to continue..."
}

do_restore() {
    echo "üîç Searching for backup.sql files..."
    files=($(find $BACKUP_ROOT -maxdepth 3 -name "*.sql" | sort -r))

    if [ ${#files[@]} -eq 0 ]; then
        echo "‚ùå No backup files found in $BACKUP_ROOT"
        read -p "Press Enter to continue..."
        return
    fi

    echo "Select a backup file to restore:"
    select file in "${files[@]}" "Cancel"; do
        if [[ "$file" == "Cancel" ]]; then
            return
        elif [[ -n "$file" ]]; then
            echo "‚ö†Ô∏è  WARNING: This will overwrite the current database!"
            read -p "Are you sure? (y/N): " confirm
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                echo "üîÑ Restoring from $file ..."
                mysql -h "$HOST" -u "$USER" -p"$PASS" "$DB_NAME" < "$file"
                if [ $? -eq 0 ]; then
                    echo "‚úÖ Restore Complete!"
                else
                    echo "‚ùå Restore Failed!"
                fi
            else
                echo "üö´ Cancelled."
            fi
            break
        else
            echo "Invalid selection."
        fi
    done
    read -p "Press Enter to continue..."
}

do_web_server() {
    echo "üåê Starting Web Server (Download & Upload)..."
    echo "-----------------------------------------------------"
    echo "üì• Download List : http://${DISPLAY_HOST}:8081/"
    echo "‚¨ÜÔ∏è  Upload Page   : http://${DISPLAY_HOST}:8081/upload"
    echo "-----------------------------------------------------"
    echo "   (Press Ctrl+C to stop the server and return to menu)"
    
    # Â∞ÇÁî®„ÅÆPython„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å
    python3 /usr/local/bin/upload_server.py
    
    read -p "Server stopped. Press Enter to continue..."
}

while true; do
    show_header
    echo "Please select an option:"
    echo "1)  üíæ  Create Backup"
    echo "2)  üîÑ  Restore Backup"
    echo "3)  üåê  Start File Server (Download / Upload)"
    echo "4)  üö™  Exit"
    echo ""
    read -p "Enter choice [1-4]: " choice

    case $choice in
        1) do_backup ;;
        2) do_restore ;;
        3) do_web_server ;;
        4) echo "Bye! üëã"; exit 0 ;;
        *) echo "Invalid option."; read -p "Press Enter..." ;;
    esac
done