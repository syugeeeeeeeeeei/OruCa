services:
  # 本番用 Nginx (ビルド機能付き)
  web:
    build:
      context: compose              # プロジェクトルートを指定 (vite/ と web/ 両方にアクセスするため)
      dockerfile: web/Dockerfile
    container_name: oruca-web
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - default
      - fukaya-lab-network
    labels:
      caddy: http://oruca.fukaya-sus.lab
      caddy.reverse_proxy: "{{upstreams 80}}"

  # API (Production Mode)
  api:
    build:
      context: compose/api
      dockerfile: Dockerfile
      target: prod            # Prodステージを使用
    container_name: oruca-api
    restart: unless-stopped
    environment:
      MYSQL_DATABASE : ${MYSQL_DATABASE}
      MYSQL_USER : ${MYSQL_USER}
      MYSQL_PASSWORD : ${MYSQL_PASSWORD}
      SLACK_BOT_TOKEN : ${SLACK_BOT_TOKEN}
      SLACK_CHANNEL_ID : ${SLACK_CHANNEL_ID}
      TZ: Asia/Tokyo
    # volumes: 削除 (コードはイメージ内にCOPY済み)
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - default

  # NFC
  nfc:
    build:
      context: compose/nfc
      dockerfile: Dockerfile
    container_name: oruca-nfc
    init: true
    restart: unless-stopped
    environment:
      - TZ=Asia/Tokyo
    command: ["python","main.py"]
    depends_on:
      - api
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
    networks:
      - default

  # MySQL (修正: バックアップのマウントを削除)
  mysql:
    build:
      context: compose/mysql
    container_name: oruca-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE : ${MYSQL_DATABASE}
      MYSQL_USER : ${MYSQL_USER}
      MYSQL_PASSWORD : ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD : ${MYSQL_ROOT_PASSWORD}
    cap_add:
      - SYS_NICE
    volumes:
      - ./compose/mysql/data/init.sql:/docker-entrypoint-initdb.d/init.sql
      - mysql_data:/var/lib/mysql
      # 削除: - ./compose/mysql/backups:/backups
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      retries: 3
      start_period: 10s
      timeout: 10s
    networks:
      - default

  # Backup Utility
  backup-util:
    container_name: oruca-backup-util
    build:
      context: compose/backup
    restart: "no"
    environment:
      # MySQLコンテナへ接続するための情報
      MYSQL_HOST: oruca-mysql
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      # root権限でバックアップ/リストアを行うため root を使用推奨
      MYSQL_USER: root
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TZ: Asia/Tokyo
    volumes:
      - database_backups:/backups
    ports:
      - "8081:8081"
    networks:
      - default
    depends_on:
      - mysql
    tty: true          # 追加: TUIを表示するために必要
    stdin_open: true   # 追加: 入力を受け付けるために必要

networks:
  default : 
    driver: bridge
  fukaya-lab-network:
    external: true
    name: fukaya-lab-network

volumes:
  mysql_data:
  database_backups: